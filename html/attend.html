<meta name="mobile-web-app-capable" content="yes">

<script>
	$(document).ready(function(){
		var target_header = "attend";
		getTeam();
		$("#header_" + target_header).addClass("text-warning").removeClass("text-white");
		$("#drop_header").text($("#drop_header_" + target_header).text());
		setLayout();
		getInitAttendPlayer();

		$("#match_key").val(getToday(""));
		$("#match_date").val(getToday("."));
		
		$('#match_date').datepicker({
			format: "yyyy.mm.dd",
			autoclose: true,
			todayHighlight: true,
			language: "ko"
		});

		getAttend();
	});

	function getToday(point){
		var str = "";
		var tmp = new Date();
		str += tmp.getFullYear();
		if(tmp.getMonth+1 < 10){
			str += point + "0" + (tmp.getMonth()+1);
		}else{
			str += point + (tmp.getMonth()+1);
		}
		if(tmp.getDate() < 10){
			str += point + "0" + tmp.getDate();
		}else{
			str += point + tmp.getDate();
		}
		return str;
	}

	$(window).resize(function(){
		setLayout();
	});

	var playersData = [];
	var selectedPlayers = [];
	function getInitAttendPlayer(){
		$.ajax({
			async: false,
			type : "post",
			url : '/football_tpm/get.php',
			data : {
				cmd : "player",
				id : 1,
			},
			dataType : "json",
			success : function(data) {
				for(var i=0; i<data.length; i++){
					var pid = data[i]["player_id"];
					playersData[pid] = data[i];
					var style = "";
					// if(selectedPlayers.indexOf(data[i]["player_id"]) > -1){
					// 	style = "display:none;";
					// }
					$("#ATTEND_PLAYERS").append("<tr id='players_"+pid+"' style='"+style+"'>"
						+"<td>"+data[i]["player_name"]
						+"  <button type='button' class='btn btn-sm btn-danger' onclick=\"setAttendTeam('a', '"+pid+"');\">A</button>"
						+"  <button type='button' class='btn btn-sm btn-primary' onclick=\"setAttendTeam('b', '"+pid+"');\">B</button>"
						+"</td>"
						+"</tr>");
				}
			},
			error : function(err) {
				alert("오류발생 관리자에게 문의하세요.")
			}
		});
	}

	function delAttendPlayer(pid){
		if(ATTEND_OFF){
			return;
		}
		if(confirm(playersData[pid]["player_name"] + "를 출석에서 제외 시키겠습니까?")){
			$("#ATTEND_PLAYER_"+pid).remove();
			setQuarters(1);
			setQuarters(2);
			setQuarters(3);
			setQuarters(4);
			setQuarters(5);
		}
	}

	function setAttendTeam(team, pid){
		if(ATTEND_OFF){
			alert("비활성상태");
			return;
		}
		var p = playersData[pid];

		$("#ATTEND_PLAYER_"+pid).remove();

		var no = 0;
		if(team == 'a'){
			no = $("#ATTEND_TEAM_A").children().length + 1;
		}else{
			no = $("#ATTEND_TEAM_B").children().length + 1;
		}

		var str = "<tr class='ATTEND_PLAYERS_"+team+"' id='ATTEND_PLAYER_"+pid+"'>";
			str += "<td onclick=\"delAttendPlayer('"+pid+"');\">"+no+"</td>";
			str += "<td onclick=\"delAttendPlayer('"+pid+"');\">"+p["player_name"]+"</td>";
			str += "<td onclick=\"setQ(1, '"+team+"', '"+pid+"');\"></td>";
			str += "<td onclick=\"setQ(2, '"+team+"', '"+pid+"');\"></td>";
			str += "<td onclick=\"setQ(3, '"+team+"', '"+pid+"');\"></td>";
			str += "<td onclick=\"setQ(4, '"+team+"', '"+pid+"');\"></td>";
			str += "<td onclick=\"setQ(5, '"+team+"', '"+pid+"');\"></td>";
			str += "</tr>";

		if(team == 'a'){
			$("#ATTEND_TEAM_A").append(str);
		}else{
			$("#ATTEND_TEAM_B").append(str);
		}
	}

	function setQ(quarter, team, pid){
		var cnt = 0;

		var target = $("#ATTEND_PLAYER_"+pid).children().eq(1+quarter);
		var t_str = target.text();
		if(t_str == 'O'){
			target.text("");
		}else{
			target.text("O");
		}
		
		var childrens = null;
		if(team == 'a'){
			childrens = $("#ATTEND_TEAM_A").children();
		}else{
			childrens = $("#ATTEND_TEAM_B").children();
		}
		
		childrens.each(function(){
			var tmp = $(this).children().eq(1+quarter).text();
			if(tmp == 'O'){
				cnt++;
			}
		});

		if(team == 'a'){
			$("#ATTEND_A_"+quarter).text(cnt);
		}else{
			$("#ATTEND_B_"+quarter).text(cnt);
		}
	}

	function getConstantVowel(kor) {
		const f = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ',
				'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ',
				'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
		const s = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ',
				'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ',
				'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
		const t = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ',
				'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ',
				'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ',
				'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

		const ga = 44032;
		let uni = kor.charCodeAt(0);

		uni = uni - ga;

		let fn = parseInt(uni / 588);
		let sn = parseInt((uni - (fn * 588)) / 28);
		let tn = parseInt(uni % 28);

		return {
			f: f[fn],
			s: s[sn],
			t: t[tn]
		};
	}

    function searchTablePlayers() {
		var tmp = $("#searchPlayerName").val();
		var getConstantValue = getConstantVowel(tmp);
		
        var chk = false;
		var idx = 0;
		$("#ATTEND_PLAYERS").children().each(function(){
			//if(idx > 0)
			{
				if($(this).children().eq(0).text().indexOf(tmp) > -1){
					$(this).show();
					chk = true;
				}else{
					$(this).hide();
					chk = false;
				}

				if(!chk){
					var tmp2 = getConstantVowel($(this).children().eq(0).text());
					if(tmp2.f == tmp){
						$(this).show();
					}else if(tmp2.f == getConstantValue.f && tmp2.s == getConstantValue.s){
						$(this).show();
					}
				}
			}
			idx++;
		});
	}

	var ATTEND_OFF = false;
	function attendOnOff(){
		if($("#BTN_ON").hasClass("btn-secondary")){
			ATTEND_OFF = true;
			$("#BTN_ON").text("활성화시키기");
			$("#BTN_ON").addClass("btn-success");
			$("#BTN_ON").removeClass("btn-secondary");
		}
		else{
			ATTEND_OFF = false;
			$("#BTN_ON").text("비활성화시키기");
			$("#BTN_ON").removeClass("btn-success");
			$("#BTN_ON").addClass("btn-secondary");
		}
	}

	function getAttend(){
		$.ajax({
			async: false,
			type : "post",
			url : '/football_tpm/get.php',
			data : {
				cmd : "attend2",
				id : 1,
				match_key: $("#match_key").val()
			},
			dataType : "json",
			success : function(data) {
				var tmp = data[0];
				var team_a = tmp["team_a"].split("$");
				var team_b = tmp["team_b"].split("$");
				var a_q1 = tmp["a_q1"];
				var a_q2 = tmp["a_q2"];
				var a_q3 = tmp["a_q3"];
				var a_q4 = tmp["a_q4"];
				var a_q5 = tmp["a_q5"];
				var a_q6 = tmp["a_q6"];
				var b_q1 = tmp["b_q1"];
				var b_q2 = tmp["b_q2"];
				var b_q3 = tmp["b_q3"];
				var b_q4 = tmp["b_q4"];
				var b_q5 = tmp["b_q5"];
				var b_q6 = tmp["b_q6"];

				for(var i=0; i<team_a.length; i++){
					if(team_a[i] != ""){
						setAttendTeam('a', team_a[i]);
						var t_p = "$" + team_a[i] + "$";
						if(a_q1.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_a[i]).children().eq(2).text("O"); }
						if(a_q2.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_a[i]).children().eq(3).text("O"); }
						if(a_q3.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_a[i]).children().eq(4).text("O"); }
						if(a_q4.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_a[i]).children().eq(5).text("O"); }
						if(a_q5.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_a[i]).children().eq(6).text("O"); }
					}
				}
				for(var i=0; i<team_b.length; i++){
					if(team_b[i] != ""){
						setAttendTeam('b', team_b[i]);
						var t_p = "$" + team_b[i] + "$";
						if(b_q1.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_b[i]).children().eq(2).text("O"); }
						if(b_q2.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_b[i]).children().eq(3).text("O"); }
						if(b_q3.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_b[i]).children().eq(4).text("O"); }
						if(b_q4.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_b[i]).children().eq(5).text("O"); }
						if(b_q5.indexOf(t_p) > -1){ $("#ATTEND_PLAYER_"+team_b[i]).children().eq(6).text("O"); }
					}
				}
				
				setQuarters(1);
				setQuarters(2);
				setQuarters(3);
				setQuarters(4);
				setQuarters(5);
			},
			error : function(err) {
				alert("오류발생 관리자에게 문의하세요.")
			}
		});
	}
	function setQuarters(quarter){
		var cnt = 0;
		var childrens = null;
		childrens = $("#ATTEND_TEAM_A").children();
		childrens.each(function(){
			var tmp = $(this).children().eq(1+quarter).text();
			if(tmp == 'O'){
				cnt++;
			}
		});
		$("#ATTEND_A_"+quarter).text(cnt);
		
		cnt = 0;
		childrens = $("#ATTEND_TEAM_B").children();
		childrens.each(function(){
			var tmp = $(this).children().eq(1+quarter).text();
			if(tmp == 'O'){
				cnt++;
			}
		});
		$("#ATTEND_B_"+quarter).text(cnt);
	}

	function saveAttend(){
		var team_a = "$";
		var team_b = "$";
		var a_q1 = "$";
		var a_q2 = "$";
		var a_q3 = "$";
		var a_q4 = "$";
		var a_q5 = "$";
		var a_q6 = "$";
		var b_q1 = "$";
		var b_q2 = "$";
		var b_q3 = "$";
		var b_q4 = "$";
		var b_q5 = "$";
		var b_q6 = "$";

		$(".ATTEND_PLAYERS_a").each(function(){
			var pid = $(this).attr("id").replace("ATTEND_PLAYER_", "");
			team_a += pid + "$";
			var tmp = $(this).children();
			if(tmp[2].innerText == "O"){ a_q1 += pid + "$"; }
			if(tmp[3].innerText == "O"){ a_q2 += pid + "$"; }
			if(tmp[4].innerText == "O"){ a_q3 += pid + "$"; }
			if(tmp[5].innerText == "O"){ a_q4 += pid + "$"; }
			if(tmp[6].innerText == "O"){ a_q5 += pid + "$"; }
		});
		$(".ATTEND_PLAYERS_b").each(function(){
			var pid = $(this).attr("id").replace("ATTEND_PLAYER_", "");
			team_b += pid + "$";
			var tmp = $(this).children();
			if(tmp[2].innerText == "O"){ b_q1 += pid + "$"; }
			if(tmp[3].innerText == "O"){ b_q2 += pid + "$"; }
			if(tmp[4].innerText == "O"){ b_q3 += pid + "$"; }
			if(tmp[5].innerText == "O"){ b_q4 += pid + "$"; }
			if(tmp[6].innerText == "O"){ b_q5 += pid + "$"; }
		});

		$.ajax({
			async: false,
			type : "post",
			url : '/football_tpm/save.php',
			data : {
				cmd : "attend2",
				id : 1,
				match_key : $("#match_key").val(),
				match_date : $("#match_date").val().replace(".", "").replace(".", ""),
				team_a : team_a,
				team_b : team_b,
				a_q1 : a_q1,
				a_q2 : a_q2,
				a_q3 : a_q3,
				a_q4 : a_q4,
				a_q5 : a_q5,
				a_q6 : a_q6,
				b_q1 : b_q1,
				b_q2 : b_q2,
				b_q3 : b_q3,
				b_q4 : b_q4,
				b_q5 : b_q5,
				b_q6 : b_q6
			},
			success : function(data) {
				if(data == "ok"){
					alert("저장되었습니다.");
				}else{
					alert("실패하였습니다.");
				}
			},
			error : function(err) {
				alert("오류발생 관리자에게 문의하세요.")
			}
		});
	}
</script>
<style>
</style>

	<div class="container" style="margin-top:10px; margin-bottom: 10px; max-width: 100%;" id="main_div">
		<div class="row">
			<div class="col">
				<button id="BTN_ON" class="btn btn-sm btn-secondary" onclick="attendOnOff();">비활성화시키기</button>
			</div>
			<div class="col">
				<div class="input-group">
					<span class="input-group-text" for="match_date">경기일자</span>
					<input type="text" id="match_date" class="form-control" value=""/>
				</div>
			</div>
			<div class="col">
				<div class="input-group">
					<span class="input-group-text">MATCH_KEY</span>
					<input type="text" id="match_key" class="form-control" value=""/>
					<button id="BTN_SAVE" class="btn btn-sm btn-primary" onclick="saveAttend();">저장</button>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-2" style="width:140px;">
				<table class="table auto_font_size text-center align-middle" style="font-size:12px;">
					<caption style="caption-side: top;">
						검색: <input type="text" id="searchPlayerName" value="" onkeyup="searchTablePlayers();" style="width:80px;"/>
					</caption>
					<tbody id="ATTEND_PLAYERS"></tbody>
				</table>
			</div>
			<div class="col">
				<table class="table auto_font_size text-center align-middle table-striped table-bordered">
					<thead>
						<tr style="background: #ffa2a2;"><th colspan="7">A팀</th></tr>
						<tr style="background: #ffa2a2;">
							<th colspan="2">체크 수</th>
							<th id="ATTEND_A_1">0</th>
							<th id="ATTEND_A_2">0</th>
							<th id="ATTEND_A_3">0</th>
							<th id="ATTEND_A_4">0</th>
							<th id="ATTEND_A_5">0</th>
						</tr>
						<tr style="background: #ffa2a2;">
							<th>#</th>
							<th>Name</th>
							<th>Q1</th>
							<th>Q2</th>
							<th>Q3</th>
							<th>Q4</th>
							<th>Q5</th>
						</tr>
					</thead>
					<tbody id="ATTEND_TEAM_A"></tbody>
				</table>
			</div>
			<div class="col">
				<table class="table auto_font_size text-center align-middle table-striped table-bordered">
					<thead>
						<tr style="background: #9d9dff;"><th colspan="7">B팀</th></tr>
						<tr style="background: #9d9dff;">
							<th colspan="2">체크 수</th>
							<th id="ATTEND_B_1">0</th>
							<th id="ATTEND_B_2">0</th>
							<th id="ATTEND_B_3">0</th>
							<th id="ATTEND_B_4">0</th>
							<th id="ATTEND_B_5">0</th>
						</tr>
						<tr style="background: #9d9dff;">
							<th>#</th>
							<th>Name</th>
							<th>Q1</th>
							<th>Q2</th>
							<th>Q3</th>
							<th>Q4</th>
							<th>Q5</th>
						</tr>
					</thead>
					<tbody id="ATTEND_TEAM_B"></tbody>
				</table>
			</div>
		</div>

	</div>